{% extends 'base.html' %}

{% block header %}
  <h1>{% block title %}Posts{% endblock %}</h1>
  {% if g.user %}
    <a class="action" href="{{ url_for('blog.create') }}">New</a>
  {% endif %}
{% endblock %}

{% block content %}
  <!-- Pagination -->
  {% if posts|length > 0 %}
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center">
        {% if page > 1 %}
          <li class="page-item"><a class="page-link" href="?page={{ page - 1 }}">Previous</a></li>
        {% endif %}
        {% for i in range(1, num_pages + 1) %}
          <li class="page-item {% if i == page %}active{% endif %}">
            <a class="page-link" href="?page={{ i }}">{{ i }}</a>
          </li>
        {% endfor %}
        {% if page < num_pages %}
          <li class="page-item"><a class="page-link" href="?page={{ page + 1 }}">Next</a></li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}

  <!-- Sorting -->
  <div class="mb-3">
    <form action="" method="get" class="form-inline justify-content-end">
      <label class="mr-2">Sort by:</label>
      <select name="sort_by" class="form-control mr-2">
        <option value="date" {% if sort_by == 'date' %}selected{% endif %}>Date</option>
        <option value="author" {% if sort_by == 'author' %}selected{% endif %}>Author</option>
      </select>
      <button type="submit" class="btn btn-primary">Sort</button>
    </form>
  </div>

  <!-- Search bar -->
  <div class="mb-3">
    <form action="" method="get" class="form-inline justify-content-end">
      <label class="mr-2">Search:</label>
      <input type="text" name="q" class="form-control mr-2" value="{{ q }}">
      <button type="submit" class="btn btn-primary">Search</button>
    </form>
  </div>

  <!-- Accordion -->
  <div id="accordion">
    {% for post in posts %}
      <div class="card">
        <div class="card-header" id="heading{{ loop.index }}">
          <h2 class="mb-0">
            <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapse{{ loop.index }}" aria-expanded="true" aria-controls="collapse{{ loop.index }}">
              {{ post['title'] }}
            </button>
            {% if g.user['id'] == post['author_id'] %}
              <a class="action" href="{{ url_for('blog.update', id=post['id']) }}">Edit</a>
            {% endif %}
          </h2>
        </div>
        <div id="collapse{{ loop.index }}" class="collapse" aria-labelledby="heading{{ loop.index }}" data-parent="#accordion">
          <div class="card-body">
            <p><strong>Author:</strong> {{ post['username'] }}</p>
            <p><strong>Created:</strong> {{ post['created'].strftime('%Y-%m-%d') }}</p>
            <p class="body">{{ post['body'] }}</p>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% endblock %}
